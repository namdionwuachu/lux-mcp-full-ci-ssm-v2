<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lux Search — Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-50">
  <main class="max-w-6xl mx-auto px-6 py-10">
    <h1 class="text-3xl font-bold">Meet Lux Search</h1>
    <p class="mt-1 text-slate-300">Planner (agent orchestrator) demo.</p>

    <form id="f" class="mt-6 grid md:grid-cols-3 gap-3">
      <!-- City name (human-friendly for query composition) -->
      <input id="city" class="rounded bg-slate-900 border border-slate-700 px-3 py-2"
             value="Paris" placeholder="City (e.g., Paris)">

      <div class="grid grid-cols-2 gap-3 md:col-span-3">
        <input id="checkIn"  type="date" class="rounded bg-slate-900 border border-slate-700 px-3 py-2" value="2025-10-31">
        <input id="checkOut" type="date" class="rounded bg-slate-900 border border-slate-700 px-3 py-2" value="2025-11-03">
      </div>

      <input id="ad"  type="number" min="1" class="rounded bg-slate-900 border border-slate-700 px-3 py-2" value="2"   placeholder="Adults">
      <input id="max" type="number" min="1" class="rounded bg-slate-900 border border-slate-700 px-3 py-2" value="500" placeholder="Max £/night">

      <label class="inline-flex items-center gap-2 text-sm text-slate-300 md:col-span-3">
        <input id="pool" type="checkbox" class="h-4 w-4" checked> Prefer indoor pool
      </label>

      <!-- (Intentionally no neighborhood/use_responder/city_code for planner route) -->

      <button class="rounded bg-cyan-400 text-slate-900 font-semibold px-4 py-2 md:col-span-3">Search</button>
    </form>

    <div id="notice" class="mt-3 text-sm text-amber-300 hidden">
      Set <code>VITE_LUX_API</code> via build env.
    </div>

    <div id="narr" class="mt-6 text-slate-200 text-base whitespace-pre-wrap"></div>
    <div id="results" class="mt-6 grid md:grid-cols-2 gap-4"></div>
  </main>

  <script type="module">
    const API_URL = import.meta.env.VITE_LUX_API || "";
    console.log("Lux API_URL:", API_URL);

    const notice     = document.getElementById('notice');
    const form       = document.getElementById('f');
    const cityEl     = document.getElementById('city');
    const checkInEl  = document.getElementById('checkIn');
    const checkOutEl = document.getElementById('checkOut');
    const adultsEl   = document.getElementById('ad');
    const maxEl      = document.getElementById('max');
    const poolEl     = document.getElementById('pool');
    const r          = document.getElementById('results');
    const narr       = document.getElementById('narr');

    if (!API_URL) notice.classList.remove('hidden');

    // Use helper (routes to Planner when payload has { query })
    import { searchHotels } from "/src/api/searchHotels.js";

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!API_URL) return;

      r.innerHTML = "<div class='text-slate-300'>Searching…</div>";
      narr.textContent = "";

      // Compose a natural-language query for the Planner Agent.
      const city    = (cityEl.value || "").trim();
      const inDate  = (checkInEl.value || "").trim();
      const outDate = (checkOutEl.value || "").trim();
      const adults  = Math.max(1, Number(adultsEl.value || 2));
      const maxGBP  = Number(maxEl.value || 0);
      const wantsPool = !!poolEl.checked;

      const parts = [
        city ? `Find a 4-star hotel in ${city}` : "Find a 4-star hotel",
        wantsPool ? "with an indoor pool" : "",
        Number.isFinite(maxGBP) && maxGBP > 0 ? `under ${maxGBP} GBP/night` : "",
        `${adults} ${adults === 1 ? "adult" : "adults"}`,
        (inDate && outDate) ? `for ${inDate} to ${outDate}` : ""
      ].filter(Boolean);

      const query = parts.join(", ").replace(/\s+,/g, ",");

      if (!query) {
        r.innerHTML = `<div class="text-amber-300">Please provide at least a city or date range.</div>`;
        return;
      }

      // IMPORTANT: Planner expects ONLY { query }
      const payload = { query };

      try {
        const data = await searchHotels(payload);

        if (data?.narrative) narr.textContent = data.narrative;

        const hotels =
          data?.hotels?.hotels ||
          data?.hotels ||
          data?.top ||
          data?.candidates ||
          [];

        const cards = (list) => list.map((h,i)=>`
          <div class="rounded border border-slate-800 bg-slate-900 p-4">
            <div class="text-xs text-slate-400">#${i+1}</div>
            <div class="text-lg font-semibold">${h.name || 'Hotel'}</div>
            <div class="text-sm text-slate-400">
              ${'★'.repeat(h.stars || 0)}
              <span class="ml-1">${h.location_note || ''}</span>
            </div>
            <div class="mt-2 text-sm">${
              typeof h.est_price_gbp === 'number' ? '£' + Math.round(h.est_price_gbp) :
              typeof h.est_price === 'number'     ? '£' + Math.round(h.est_price) :
              'Price TBD'
            }</div>
            <div class="mt-2 text-xs text-slate-400">${(h.amenities || []).slice(0,6).join(' · ')}</div>
          </div>`).join('');

        r.innerHTML = hotels.length
          ? cards(hotels)
          : '<div class="text-slate-300">No results.</div>';
      } catch (err) {
        r.innerHTML = `<div class="text-rose-300">Error: ${err.message}</div>`;
      }
    });
  </script>
</body>
</html>

